<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>熊猫文档专注于编程技术</title>
    <link rel="stylesheet" href="/lib/bootstrap-4.3.1-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/dashidan.css">
</head>

<body>

<nav id="nav_bar" class="navbar navbar-expand sticky-top">
    <div class="btn-group" role="group">
        <button type="button" id="nav_btn_index" class="btn btn-primary">首页</button>
        <button type="button" id="nav_btn_ask" class="btn btn-primary">问答</button>
        <button type="button" id="nav_btn_rank" class="btn btn-primary">排行榜</button>
    </div>

    <div id="index_login_state">
        <button type="button" id="nav_btn_login" class="btn btn-success ml-auto">登录</button>
    </div>
</nav>

<div id="content_area">

</div>

<script src="/lib/jquery-3.2.1.min.js"></script>
<script src="/lib/bootstrap-4.3.1-dist/js/popper.min.js"></script>
<script src="/lib/bootstrap-4.3.1-dist/js/bootstrap.min.js"></script>
<script src="/lib/google-code-prettify/run_prettify.js"></script>
<script src="/lib/mustache/mustache.js"></script>

<script src="/js/index.js"></script>
<script src="/js/hbs.js"></script>
<script src="/js/doc.js"></script>
<script src="/js/rank.js"></script>
<script src="/js/login.js"></script>
<script src="/js/ask.js"></script>
<script src="/js/profile.js"></script>

<script>
    /** 全局变量*/
    /** 当前文档tag*/
    let global_tag = '';
    /** 语言状态*/
    let global_lan = 'zh_cn';
    /** 当前文档显示的文章*/
    let global_page = 1;
    /** 当前文档显示的文章的锚点*/
    let global_anchor = '1_';
    /** 登陆状态*/
    let global_login_state = false;

    $(document).ready(function () {
        console.log('index document ready.');
        /** 事件初始化*/
        $('#nav_bar').off('click', 'button', navClickBtn);
        $('#nav_bar').on('click', 'button', navClickBtn);
        /** 加载index框架*/
        let url_index = '/ajax/index.html';
        ajax_get(url_index, indexLoadSuccess);

        /** 获取头像信息，如果没有则显示登录按钮*/
        let url_figure = '/php/figure_url.php';
        ajax_get(url_figure, onGetFigureUrl);

        /**
         * 通过get参数，初始化页面
         * url 示例:
         * /index.html?tag=%E6%8A%80%E6%9C%AF%E8%AE%A8%E8%AE%BA&language=zh_cn&contentid=100051&nav=ask
         */
        let nav = getQueryString('nav');
        if (nav) {
            if (nav === 'ask') {
                /** 跳转至问答*/
                global_tag = getQueryString('tag');
                global_lan = getQueryString('language');

                let content_id = getQueryString('contentid');
                active_nav_button('nav_btn_ask');

                getAskInfo(global_tag, content_id);
            }
        }
    });

    function onGetFigureUrl(res) {
        console.log('onGetFigureUrl res ' + res);
        if (res) {
            global_login_state = true;
            /** 已经登陆，获取头像信息, 显示头像图标*/
            let login_state_btn = '<button type="button" id="nav_btn_figure" class="btn btn-success ml-auto"><img id="nav_btn_figure"  class="rounded" src="' + res + '" width="24px" height="24px"></button>';
            $("#index_login_state").html(login_state_btn);
        }
    }

    /** 导航按钮点击事件*/
    function navClickBtn(e) {
        let btn_id = $(e.target).attr("id");
        active_nav_button(btn_id);

        let url = '';
        switch (btn_id) {
            case 'nav_btn_index':
                url = '/ajax/index.html';
                ajax_get(url, indexLoadSuccess);
                break;
            case 'nav_btn_ask':
                url = '/ajax/ask.html';
                ajax_get(url, askLoadSuccess);
                break;
            case 'nav_btn_rank':
                url = '/ajax/rank.html';
                ajax_get(url, rankLoadSuccess);
                break;
            case 'nav_btn_login':
                showLoginPage();
                break;
            case 'nav_btn_figure':
                url = '/ajax/profile.html';
                ajax_get(url, loadProfileSuccess);
                break;
        }
    }

    /** 显示登录页面*/
    function showLoginPage() {
        let url = '/ajax/login.html';
        ajax_get(url, loginLoadSuccess);
    }

    /** 导航按钮状态切换*/
    function active_nav_button(id) {
        $("#nav_btn_index").removeClass("active");
        $("#nav_btn_ask").removeClass("active");
        $("#nav_btn_rank").removeClass("active");
        $("#nav_btn_login").removeClass("active");
        $('#' + id).addClass("active");
    }

    function ajax_post(link_name, data, callback_success) {
        console.log("ajax_post: " + link_name + " data " + data);
        $.ajax({
            type: 'POST',
            url: link_name,
            data: data,
            success: callback_success
        });
    }

    /** 全局ajax_get方法-异步*/
    function ajax_get(url_get, callback_success) {
        console.log('ajax_get: ' + url_get);
        $.ajax({
            url: url_get,
            success: callback_success
        });
    }

    /** 刷新content_area区域内容*/
    function refreshContentArea(content) {
        $("#content_area").html(content);
    }

    /** 获取get参数*/
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return r[2];
        return null;
    }
</script>
</body>
</html>